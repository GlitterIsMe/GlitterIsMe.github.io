---
title: 一致性协议(2)
date: 2018-06-11 17:13:38
tags: [Consistency,Paxos]
categories: Tech
---

# 一致性协议(2)
## Paxos协议
Paxos协议是分布式一致性协议中比较重要的协议之一，但是由于其理解上的复杂性，所以Paxos协议实现上很多跟Paxos本身的理论有一定偏差。

<!-- more -->

### 副本状态机模型
副本状态机模型是对各种不同场景的抽象化表达，一种典型的副本状态机是基于LOG实现的副本状态机。
![](https://ws1.sinaimg.cn/large/8c185877gy1fs71ufwjfvj20dt08h3z5.jpg)
副本状态机通过LOG记录客户端来的操作，然后服务器执行这些操作应用到状态机上，如果LOG状态是一致的，那么就能保证状态机状态是一致的，一致性协议就是保证LOG状态一致。
对一致性协议的要求：
- 安全性：非拜占庭模型下状态机不返回错误的结果，多提议中只有一个提议能正确执行
- 可用性：大多数服务器正常则服务可用
- 通过维护log一致，则通知客户端操作成功，加快请求处理速度

### Paxos协议
- 单Paxos：副本状态机中各个服务器针对LOG中固定的某个位置的操作命令通过协议达成一致
- 多Paxos：针对多个位置达成一致，通常由多个单Paxos组成

### Paxos协议角色划分
倡议者：提出建议一共投票表决
接受者：对倡议者提出的建议进行投票表决，选择其中之一
学习者：从接受者获知哪个提议被最终选中

### Paxos协议内容
在非拜占庭条件下，**多个并行程序提出不同操作命令，如何达成一致**，总体分为两个过程
**阶段一**：
1. **倡议者**：选择倡议编号n，选择向大多数接受者发送prepare请求并附带n
2. **接受者**：对于接受编号为n的Prepare请求：
	- 如果n比接受者之前响应过的其他Prepare请求附带的倡议编号都大，则此接受者响应倡议者，并承诺不会响应之后接收到的其他编号小于n的请求。如果接受者响应过Accept请求，则将响应的Accept请求中编号最高的倡议内容发送给倡议者，包含Accept请求中的倡议编号以及倡议值。
	- 如果n不比接受者之前响应过的其他任何prepare请求的倡议编号都大，则不会响应。

**阶段二**：
1. **倡议者**：如果接收到大多数接受者关于带有倡议编号n的prepare请求的响应，则倡议者向这些接受者发送Accept请求，包含n与倡议值v（对于这个v，如果1.2阶段接受者返回了自己曾接受的具有最高倡议编号Accept请求的倡议内容，则选择这些倡议内容中编号最高的倡议值，否则v可以为任意值）
2. **接受者**：如果接受者接受到了任意倡议编号为n的Accept请求则接受此请求，除非该期间响应了具有比n更高编号的prepare请求

经过以上的两个阶段就能为唯一地确定一个倡议编号，**学习者**则从接受者处获知接受的请求并执行。
 > 《大数据日知录》——大数据基础理论——数据复制与一致性