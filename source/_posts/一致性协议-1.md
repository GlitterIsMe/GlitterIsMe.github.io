---
title: 一致性协议(1)
date: 2018-06-11 17:11:31
tags: [Consistency,2PC]
categories: Tech
---
# 一致性协议(1)
## 两阶段提交协议（Two-Phrase Commit, 2PC）
作用：实现分布式事务的原子性操作，也可用于实现数据的强一致性，但是因为一些缺点一般很少这么用，更多的是用于保证数据更新的原子性手段.
<!-- more -->

### 两类实体
- 协调者(Coordinator)：管理协调
- 参与者(Participants)

### 两个阶段
- 表决阶段(Voting)：
协调者：向所有的参与者发送VOTE_REQUEST信息
参与者：接收VOTE_REQUEST信息，返回VOTE_COMMIT告知准备好提交，或者返回VOTE_ABORT告知无法提交
- 提交阶段(Commit)：
协调者：收集表决信息，如果所有的参与者都能够提交，则向所有参与者发送提交信息GLOBAL_ABORT；如果有任意一个不能提交，则发送GLOBAL_ABORT取消本次事务。
参与者：接收GLOBAL_COMMIT提交或者接收GLOBAL_ABORT取消

### 有限状态机
![](https://ws1.sinaimg.cn/large/8c185877gy1fs716cy169j20vy0gm74y.jpg)
发生阻塞的情况：
- 协调者等待所有参与者的信息
- 参与者等待协调者的commit请求
- 参与者等待协调者的commit决策

### 两种解决阻塞的机制
- 超时机制：请求等待阶段引入超时判断，当等待请求超过一段时间没有回应时自动abort。如协调者等待所有参与者的回应或者参与者等待协调者的commit请求。
- 参与者互询：
	场景：参与者进入Ready阶段，但是等待协调者的决策
    描述：参与者P与参与者Q，P未收到协调者的决策信息，P询问参与者Q，则根据Q的状态，可以大致决定P的状态：
    1.COMMIT，协调者已经发送了GLOBAL_COMMIT，则P也commit；
    2.2.ABORT，协调者发送了GLOBAL_ABORT，则P也abort；
    3.3.INIT，协调者仍处理表决阶段，Q超时，abort更为安全；
    4.4.READY，Q也同样在等，**阻塞**
    
 ### 2PC的优化——3PC
 优化点：引入pre-commit阶段，消除可以直接转换到COMMIT以及ABORT的单独状态（协调者的WAIT以及参与者的READY），消除做最后决定并可以转到COMMIT以及ABORT的状态（协调者的WAIT以及参与者的READY）
 ![](https://ws1.sinaimg.cn/large/8c185877gy1fs716d4371j20w60gs3yz.jpg)
 
 > 《大数据日知录》——大数据基础理论——数据复制与一致性